# コンタクト管理機能 要件定義書

## 1. 概要

本文書は、ClickFunnelsのコンタクト管理機能をクローンするための詳細な要件定義書です。コンタクト管理は、ファネル内で獲得したリードや顧客の情報を一元管理し、セグメンテーション、タグ付け、インポート/エクスポート、自動化などの機能を提供します。

### 1.1 目的

- 顧客データの一元管理
- 顧客のセグメンテーションとターゲティング
- マーケティングオートメーションのためのデータ基盤
- 顧客エンゲージメントの追跡と分析

### 1.2 主要機能

1. コンタクト一覧表示と検索
2. コンタクトプロファイル管理
3. カスタム属性管理
4. タグ管理とセグメンテーション
5. インポート/エクスポート機能
6. 一括操作（バルクアクション）
7. アクティビティ追跡
8. ファネルからの自動タグ付け

---

## 2. データモデル

### 2.1 Contactエンティティ

#### 標準フィールド

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | コンタクトの一意識別子 |
| email | String(255) | ✓ | メールアドレス（ユニーク） |
| first_name | String(100) | - | 名 |
| last_name | String(100) | - | 姓 |
| phone | String(50) | - | 電話番号 |
| street_1 | String(255) | - | 住所1 |
| street_2 | String(255) | - | 住所2 |
| city | String(100) | - | 市区町村 |
| state | String(100) | - | 都道府県/州 |
| country | String(100) | - | 国 |
| zip_code | String(20) | - | 郵便番号 |
| timezone | String(50) | - | タイムゾーン |
| source | String(255) | - | 獲得元（ファネル名、インポートなど） |
| subscription_status | Enum | ✓ | 購読状態（subscribed/unsubscribed） |
| ltv | Decimal(10,2) | - | 生涯顧客価値（Lifetime Value） |
| created_at | Timestamp | ✓ | 作成日時 |
| updated_at | Timestamp | ✓ | 最終更新日時 |
| workspace_id | UUID | ✓ | ワークスペースID（外部キー） |

#### リレーション

- `belongsTo`: Workspace（ワークスペース）
- `belongsToMany`: Tag（タグ）via ContactTag
- `hasMany`: ContactAttribute（カスタム属性値）
- `hasMany`: ContactActivity（アクティビティ）
- `hasMany`: Order（注文）
- `hasMany`: Enrollment（コース登録）
- `hasMany`: ContactNote（メモ）
- `belongsToMany`: Segment（セグメント）via ContactSegment

### 2.2 ContactAttributeDefinitionエンティティ

カスタム属性の定義を管理

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | 属性定義の一意識別子 |
| workspace_id | UUID | ✓ | ワークスペースID |
| key | String(100) | ✓ | 属性のキー（プログラム用、ユニーク） |
| label | String(255) | ✓ | 属性の表示ラベル |
| field_type | Enum | ✓ | フィールドタイプ（text/select） |
| options | JSON | - | セレクトフィールドの選択肢 |
| allow_multiple | Boolean | - | 複数選択を許可（selectの場合） |
| created_at | Timestamp | ✓ | 作成日時 |
| updated_at | Timestamp | ✓ | 最終更新日時 |

### 2.3 ContactAttributeValueエンティティ

各コンタクトのカスタム属性値を保存

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | 一意識別子 |
| contact_id | UUID | ✓ | コンタクトID |
| attribute_definition_id | UUID | ✓ | 属性定義ID |
| value | Text | - | 属性値（JSON配列も可） |
| created_at | Timestamp | ✓ | 作成日時 |
| updated_at | Timestamp | ✓ | 最終更新日時 |

### 2.4 Tagエンティティ

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | タグの一意識別子 |
| workspace_id | UUID | ✓ | ワークスペースID |
| name | String(100) | ✓ | タグ名（ワークスペース内でユニーク、大文字小文字区別なし） |
| color | String(7) | - | タグの色（HEX形式） |
| created_at | Timestamp | ✓ | 作成日時 |
| updated_at | Timestamp | ✓ | 最終更新日時 |

### 2.5 ContactTagエンティティ（中間テーブル）

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | 一意識別子 |
| contact_id | UUID | ✓ | コンタクトID |
| tag_id | UUID | ✓ | タグID |
| created_at | Timestamp | ✓ | タグ付け日時 |

### 2.6 Segmentエンティティ

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | セグメントの一意識別子 |
| workspace_id | UUID | ✓ | ワークスペースID |
| name | String(255) | ✓ | セグメント名 |
| is_smart | Boolean | ✓ | スマートリスト（動的）か静的リストか |
| rules | JSON | - | スマートリストのフィルタルール |
| created_at | Timestamp | ✓ | 作成日時 |
| updated_at | Timestamp | ✓ | 最終更新日時 |

### 2.7 ContactActivityエンティティ

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | アクティビティの一意識別子 |
| contact_id | UUID | ✓ | コンタクトID |
| activity_type | Enum | ✓ | アクティビティタイプ（pageview/visit/workflow/note/tag/enrollment など） |
| description | Text | - | アクティビティの説明 |
| metadata | JSON | - | 追加のメタデータ |
| occurred_at | Timestamp | ✓ | アクティビティ発生日時 |
| created_at | Timestamp | ✓ | 作成日時 |

### 2.8 ContactNoteエンティティ

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | メモの一意識別子 |
| contact_id | UUID | ✓ | コンタクトID |
| content | Text | ✓ | メモの内容 |
| created_by | UUID | ✓ | 作成者（ユーザーIDまたはワークフローID） |
| created_at | Timestamp | ✓ | 作成日時 |
| updated_at | Timestamp | ✓ | 最終更新日時 |

### 2.9 ContactActionエンティティ

一括操作（バルクアクション）の履歴を管理

| フィールド名 | データ型 | 必須 | 説明 |
|------------|---------|------|------|
| id | UUID | ✓ | アクションの一意識別子 |
| workspace_id | UUID | ✓ | ワークスペースID |
| action_type | Enum | ✓ | アクションタイプ（import/export/delete/tag/workflow/enrollment/unsubscribe） |
| status | Enum | ✓ | ステータス（queued/processing/completed/failed） |
| total_count | Integer | - | 対象コンタクト総数 |
| success_count | Integer | - | 成功数 |
| failed_count | Integer | - | 失敗数 |
| metadata | JSON | - | アクション固有のメタデータ |
| file_url | String(500) | - | エクスポートファイルのURL（exportの場合） |
| scheduled_at | Timestamp | - | スケジュール実行日時 |
| started_at | Timestamp | - | 実行開始日時 |
| completed_at | Timestamp | - | 完了日時 |
| created_by | UUID | ✓ | 実行ユーザーID |
| created_at | Timestamp | ✓ | 作成日時 |
| updated_at | Timestamp | ✓ | 最終更新日時 |

---

## 3. 機能要件

### 3.1 コンタクト一覧ページ

#### 3.1.1 アクセス方法

- 左サイドメニュー「Customers」→「Contacts」をクリック

#### 3.1.2 UI要素

##### ステータスフィルタタブ

- **All**: すべてのコンタクトを表示
- **Subscribed**: 有効なメールアドレスを持ち、購読中のコンタクトのみ表示
- **Unsubscribed**: 購読解除したコンタクトのみ表示

##### 検索バー

- コンタクトの名前またはメールアドレスで検索
- リアルタイム検索（入力中に結果が更新される）
- プレースホルダー: "Search Contacts"

##### フィルタボタン

- 「Filter」ボタンをクリックしてフィルタモーダルを表示
- 複数の条件を組み合わせてフィルタリング可能
- フィルタ条件:
  - コンタクト詳細（email, name, tags）
  - コンタクトアクティビティ（last updated, viewed product page, enrolled in a course）
  - カスタム属性
- AND/OR条件の組み合わせ可能
- フィルタグループの追加可能
- 「Save Filter」でセグメントとして保存可能

##### ソートオプション

- 「Sort by」ドロップダウン
- ソート項目:
  - LTV（生涯顧客価値）
  - Date Added（追加日）
  - Last Updated（最終更新日）
- 昇順/降順の切り替え可能

##### コンタクトテーブル

- 列の構成:
  - チェックボックス（一括選択用）
  - アバター/イニシャル
  - Email Address
  - Name
  - Tags（カラフルなバッジで表示）
  - LTV（金額）
  - Last Updated（日時）
  - Actions（アクションメニュー）
- ページネーション（1ページあたりの表示件数: 25/50/100）
- 全選択チェックボックス（ヘッダー行）

##### アクションボタン

- **Add Contact**: 新規コンタクトを手動追加
- **Actions**: アクション履歴を確認
  - Imports
  - Exports
  - Enrollments
  - Tagging
  - Workflows
  - Deletions
- **Bulk Actions**: 複数選択時に表示
  - Create Enrollment
  - Delete Contacts
  - Export
  - Run Workflow
  - Tags
  - Unsubscribe Contacts

#### 3.1.3 機能要件

##### FR-CT-001: コンタクト一覧表示

- すべてのコンタクトをテーブル形式で表示
- デフォルトソート: Last Updated（降順）
- レスポンシブデザイン対応
- 遅延読み込み（lazy loading）またはページネーション

##### FR-CT-002: ステータスフィルタリング

- 購読状態による即座のフィルタリング
- タブクリックで結果が更新される
- 各タブに該当件数を表示

##### FR-CT-003: 検索機能

- 部分一致検索（名前、メールアドレス）
- デバウンス処理（300ms）でAPIリクエスト最適化
- 検索結果のハイライト表示

##### FR-CT-004: 高度なフィルタリング

- 複数条件の組み合わせ
- AND/OR条件のサポート
- フィルタグループの追加
- 保存済みフィルタの読み込み
- フィルタのクリア機能

##### FR-CT-005: ソート機能

- 各列でのソート可能
- ソート状態の保存（セッション間）
- ソートインジケーター表示

##### FR-CT-006: 一括選択

- 個別チェックボックスでの選択
- 全選択/全解除機能
- 選択中の件数表示
- 選択状態の視覚的フィードバック

### 3.2 コンタクトプロファイル

#### 3.2.1 アクセス方法

- コンタクト一覧からアバターまたはメールアドレスをクリック

#### 3.2.2 プロファイルページ構成

##### タブナビゲーション

- **Overview**: コンタクト情報の概要
- **Activity**: アクティビティタイムライン
- **Orders**: 注文履歴
- **Enrollments**: コース登録情報
- **Fulfillments**: フルフィルメント情報

##### Overview タブの構成要素

###### Contact セクション

- Email Address（編集可能）
- Phone Number（編集可能）
- Tags（タグの追加/削除）
- Timezone（自動検出または手動設定）
- Source（獲得元の表示）

###### Custom Attributes セクション

- カスタム属性の一覧表示
- 属性値の編集
- 新規属性の追加

###### Shipping Addresses セクション

- 配送先住所の一覧
- 住所の追加/編集/削除
- デフォルト住所の設定

###### Payment Methods セクション

- 保存済み支払い方法の一覧
- 支払い方法の追加/削除
- セキュアな表示（カード番号の一部マスク）

###### Credit Memos セクション

- クレジットメモの一覧
- 新規クレジットメモの作成
- 詳細表示

#### 3.2.3 Activity タブ

##### アクティビティタイムライン

- 時系列でのアクティビティ表示
- アクティビティタイプ:
  - **Pageviews**: ページ閲覧履歴（ページ名、タイムスタンプ、リンク）
  - **Visits**: 訪問記録（日時、場所）
  - **Workflows**: ワークフロー実行履歴（ステップ完了、待機など）
  - **Community Posts**: コミュニティへの投稿やエンゲージメント
  - **Notes**: 追加されたメモ
  - **Tags**: タグの追加/削除履歴
  - **Enrollments**: コース登録/解除
- 各アクティビティのタイムスタンプ表示
- 無限スクロールまたはページネーション

#### 3.2.4 機能要件

##### FR-CT-007: プロファイル表示

- コンタクトの全情報を一画面で確認可能
- タブによる情報の整理
- リアルタイムデータの反映

##### FR-CT-008: プロファイル編集

- インライン編集機能
- バリデーション（メールアドレス、電話番号など）
- 変更の即座の保存
- 編集履歴の記録

##### FR-CT-009: タグ管理

- タグの追加（複数同時可能）
- タグの削除
- タグのオートコンプリート
- タグカラーの視覚的表示

##### FR-CT-010: アクティビティ追跡

- すべてのアクティビティの記録
- タイムライン形式での表示
- フィルタリング機能（アクティビティタイプ別）
- 検索機能

##### FR-CT-011: メモ機能

- コンタクトへのメモ追加
- メモの編集/削除
- 作成者と日時の記録
- リッチテキストエディタサポート

### 3.3 コンタクト管理操作

#### 3.3.1 コンタクトの追加

##### 手動追加

- 「Add Contact」ボタンからモーダルを表示
- 入力フォーム:
  - Email Address（必須）
  - First Name
  - Last Name
  - Phone
  - 住所情報（Street 1, Street 2, City, State, Country, Zip Code）
  - Tags（複数選択可能）
- バリデーション:
  - メールアドレスの形式チェック
  - 重複メールアドレスの検出
  - 電話番号の形式チェック
- 保存時にアクティビティ記録（source: "Manual"）

#### 3.3.2 コンタクトの編集

- プロファイルページから各フィールドを編集
- インライン編集とモーダル編集の両方をサポート
- 変更履歴の自動記録
- Last Updated タイムスタンプの更新

#### 3.3.3 コンタクトの削除

##### 単一削除

- コンタクトのActionsメニューから「Delete」を選択
- 確認ダイアログ表示
- 削除条件チェック:
  - アクティブな購読がある場合は削除不可
  - コース登録がある場合は削除不可
  - アクティブな注文がある場合は削除不可
- 削除実行
- 削除履歴の記録

##### 一括削除

- 複数選択 → Bulk Actions → Delete Contacts
- 削除前の確認
- "DELETE"とタイプして確認
- 削除不可能なコンタクトは「Failed Contacts」セクションに表示
- 削除可能なコンタクトのみ削除実行

#### 3.3.4 機能要件

##### FR-CT-012: コンタクト追加

- バリデーション機能
- 重複チェック
- 自動的なタイムゾーン検出
- ソース情報の記録

##### FR-CT-013: コンタクト編集

- すべてのフィールドの編集可能性
- リアルタイムバリデーション
- 変更の即座の保存オプション
- エラーハンドリング

##### FR-CT-014: コンタクト削除

- 削除前のチェック（関連データの確認）
- カスケード削除またはソフトデリート
- 削除不可能な場合の明確なエラーメッセージ
- 削除履歴の保持

### 3.4 カスタム属性管理

#### 3.4.1 カスタム属性の作成

##### アクセス方法

- Workspace Settings → Contact Attributes
- 「Add Contact Attribute」ボタンをクリック

##### 作成フォーム

- **Label**: 属性の表示名（例: "Favorite Snack"）
- **Field Type**: フィールドタイプの選択
  - Text Field: 自由入力テキスト
  - Select Field: ドロップダウン選択
- **Options** (Select Fieldの場合):
  - 選択肢の追加/削除
  - 各選択肢の値とラベル
- **Allow Multiple Selections**: 複数選択を許可（Select Fieldの場合）
- **Key**: プログラム用のキー（自動生成、編集可能）
  - 英数字、ダッシュ、アンダースコアのみ
  - スペース不可

#### 3.4.2 カスタム属性の管理

- 属性一覧の表示
- 属性の編集
- 属性の削除（使用中の場合は警告）
- 属性の並び順変更

#### 3.4.3 カスタム属性の使用

##### フォームでの収集

- カスタム入力フィールドとして配置
- フィールドタイプに応じた入力UI
- バリデーション

##### ワークフローでの更新

- "Contact Custom Attribute"ステップ
- 属性の追加/削除
- 条件分岐での利用

##### フィルタリングでの使用

- カスタム属性での検索
- カスタム属性でのセグメンテーション

#### 3.4.4 機能要件

##### FR-CT-015: 属性定義管理

- 属性の作成/編集/削除
- フィールドタイプのサポート（Text, Select）
- 選択肢の動的管理
- キーの自動生成とバリデーション

##### FR-CT-016: 属性値管理

- コンタクトごとの属性値保存
- 複数選択のサポート（JSON配列）
- 属性値の検証
- デフォルト値の設定

##### FR-CT-017: 属性のインポート

- CSV インポート時のカスタム属性マッピング
- 新規属性の作成オプション
- バリデーションエラーの表示

### 3.5 タグ管理

#### 3.5.1 タグの作成

##### アクセス方法

- Workspace Settings → Tags → Contacts
- 「Add Tag」ボタンをクリック

##### 作成フォーム

- **Tag Name**: タグの名前（ユニーク、大文字小文字区別なし）
- **Color**: タグの色（カラーピッカー）
- バリデーション:
  - タグ名の重複チェック
  - タグ名は必須

#### 3.5.2 タグの管理

- タグ一覧の表示
- タグの編集（名前、色）
- タグの削除
- タグの使用数表示

#### 3.5.3 コンタクトへのタグ付け

##### 手動タグ付け

- コンタクトプロファイルから追加
- コンタクト一覧のActionsメニューから追加
- Bulk Actionsでの一括タグ付け

##### タグ付けオプション

- **Add Tag**: タグを追加
- **Remove Tag**: タグを削除
- 複数タグの同時追加/削除
- スケジュール実行可能（日時指定）

#### 3.5.4 タグによるフィルタリング

- フィルタ条件でタグを選択
- AND/OR条件の組み合わせ
- 複数タグでの絞り込み

#### 3.5.5 ワークフローでのタグ操作

##### "Tag Contact"ステップ

- タグの追加または削除
- 複数タグの操作
- 条件分岐でのタグ確認

##### ユースケース

- **セグメンテーション**: 行動に基づく自動タグ付け
- **動的コンテンツ配信**: タグに基づくパーソナライゼーション
- **オートメーショントリガー**: タグを条件とした別ワークフローの起動

#### 3.5.6 ファネルからの自動タグ付け

- ファネル内の特定アクションでタグ自動付与
- タグ付けのトリガー:
  - ページ訪問
  - フォーム送信
  - 商品購入
  - リンククリック
- ファネル設定でのタグ付けルール定義

#### 3.5.7 ベストプラクティス

##### タグ命名規則

- わかりやすく一貫性のある命名
- 例: "buyer-ProductName", "lead-OfferName"
- カテゴリ別のプレフィックス使用

##### タグの整理

- 過度なタグ付けを避ける
- 明確な目的を持ったタグのみ作成
- 定期的な見直しと整理

##### タグ削除の注意点

- タグ削除はワークフローに影響する可能性
- トリガー条件として使用中のタグは慎重に削除
- 削除前に使用状況を確認

#### 3.5.8 機能要件

##### FR-CT-018: タグ管理

- タグの作成/編集/削除
- タグ名の一意性チェック（大文字小文字無視）
- カラー選択機能
- 使用数のカウント

##### FR-CT-019: タグ付け操作

- 単一/一括タグ付け
- タグの追加/削除
- スケジュール実行
- アクション履歴の記録

##### FR-CT-020: タグによる検索とフィルタリング

- タグでのコンタクト検索
- 複数タグでのフィルタリング
- AND/OR条件のサポート

### 3.6 セグメント（スマートリスト）

#### 3.6.1 セグメントの種類

##### スマートリスト（動的）

- ルールに基づいて自動的にコンタクトを追加/削除
- リアルタイムでの更新
- 条件に合致しなくなったコンタクトは自動除外

##### 静的リスト

- 手動でコンタクトを追加
- 一度追加したコンタクトは条件に関係なく保持
- 手動でのみ削除可能

#### 3.6.2 スマートリストの作成

##### アクセス方法

- Follow-Up Funnels → Email Lists
- 「+Add New List」ボタンをクリック

##### 作成フォーム

- **Name**: リスト名（わかりやすく目的を反映）
- **Smart List Settings**: スマートリストのオン/オフ
- **Rule Groups**: フィルタルールの定義

##### ルールグループの設定

- 各ルールグループ内の条件はAND関係
- 複数のルールグループはOR関係
- ルール項目の例:
  - タグを持つ/持たない
  - カスタム属性の値
  - 購読状態
  - 購入履歴
  - ページ訪問履歴
  - 最終更新日
  - LTV（生涯顧客価値）

##### ルールの更新

- 「Update List」ボタンで保存
- 計算処理に最大20分かかる場合あり
- 完了後にリスト内のコンタクト数が更新

#### 3.6.3 セグメントの管理

- セグメント一覧の表示
- スマートリストと静的リストの区別（アイコン表示）
- セグメントの編集
- セグメントの削除
- コンタクト数の表示

#### 3.6.4 セグメントの使用

##### メール送信

- セグメントを宛先として選択
- ターゲティングされたメール配信

##### フィルタリング

- コンタクト一覧でセグメント別に表示
- セグメント内のコンタクトのみに操作を適用

##### ワークフロー

- セグメントをトリガー条件として使用
- セグメントへの追加/削除でワークフロー起動

#### 3.6.5 機能要件

##### FR-CT-021: セグメント作成

- スマートリストと静的リストの両方をサポート
- 複雑なルールグループの定義
- AND/OR条件の組み合わせ
- ルールの保存と編集

##### FR-CT-022: セグメント計算

- スマートリストの自動更新
- 定期的な再計算（バッチ処理）
- 計算状態の表示（計算中/完了）
- パフォーマンス最適化

##### FR-CT-023: セグメント管理

- セグメント一覧の表示
- 名前/ルールの編集
- セグメントの削除
- 使用状況の追跡

##### FR-CT-024: 静的リストへの追加制限

- スマートリストには手動追加不可
- スマートリストからは手動削除不可
- Mass Actionsでのスマートリスト除外

### 3.7 インポート機能

#### 3.7.1 CSVインポート

##### アクセス方法

- Customers → Contacts → Actions → Import

##### CSVファイルの要件

- ファイル形式: .csv
- 最初の行: 列ラベル（First Name, Last Name, Email Address など）
- 空の行や列を含まない
- 最低限必須: メールアドレス
- インポート制限: 1回あたり最大5,000件

##### インポート可能なフィールド

- First Name
- Last Name
- Email Address
- Phone
- Street 1
- Street 2
- City
- State
- Country
- Zip Code
- カスタム属性（事前定義が必要）

##### インポート手順

1. CSVファイルの選択/アップロード
2. フィールドマッピングの調整
   - CSV列とClickFunnelsフィールドの対応付け
   - プレビュー表示
   - マッピング設定の保存（再利用可能）
3. カスタム属性への割り当て（オプション）
   - 既存の属性定義から選択
   - 新規属性の作成
4. インポート実行
   - 検証処理
   - エラーチェック
   - 重複チェック（メールアドレス）

##### インポート処理

- バックグラウンド処理
- 処理時間: ファイルサイズに応じて0〜20分
- 成功通知（グリーンの通知バー）
- Actions → Imports で進捗確認

##### インポート後の確認

- インポート成功数
- インポート失敗数
- エラー詳細（失敗した場合）
- 失敗レコードのエクスポート

#### 3.7.2 機能要件

##### FR-CT-025: CSVアップロード

- ファイルサイズの検証（最大制限）
- フォーマットの検証
- エラーハンドリング

##### FR-CT-026: フィールドマッピング

- 自動検出（列名からの推測）
- 手動調整可能
- マッピング設定の保存と再利用
- プレビュー機能

##### FR-CT-027: バリデーション

- メールアドレス形式チェック
- 重複チェック
- 必須フィールドチェック
- データ型チェック

##### FR-CT-028: インポート処理

- 非同期処理（キュージョブ）
- 進捗状況の追跡
- エラーログの記録
- ロールバック機能（失敗時）

##### FR-CT-029: インポート履歴

- インポートアクションの記録
- 成功/失敗の統計
- エラー詳細の保存
- 失敗レコードのダウンロード

### 3.8 エクスポート機能

#### 3.8.1 コンタクトのエクスポート

##### アクセス方法

- コンタクト選択 → Actions / Bulk Actions → Export

##### エクスポート手順

1. コンタクトの選択
   - 個別選択
   - 一括選択
   - フィルタ適用後の全選択
2. エクスポートフィールドの選択
   - Email Address
   - Phone Number
   - LTV
   - Last Updated
   - カスタムフィールド（チェックボックスで選択）
3. スケジュール設定（オプション）
   - 即座に実行
   - 指定日時に実行
4. エクスポートアクションの作成

##### エクスポート処理

- バックグラウンド処理
- 処理完了後にメール通知
  - 件名: "Your CSV export is ready for download"
  - ダウンロードリンク付き
- ダウンロードリンクの有効期限: 30日間
- 処理時間: 最大24〜48時間（大量データの場合）

##### エクスポートファイル

- ファイル形式: CSV
- エンコーディング: UTF-8
- 選択したフィールドのみ含まれる
- ヘッダー行付き

#### 3.8.2 ファネルからのエクスポート（Classic）

- ファネル選択 → Contacts タブ
- 期間の選択（Showing Contacts For ドロップダウン）
- 「Download Contacts」ボタンをクリック

#### 3.8.3 機能要件

##### FR-CT-030: エクスポート設定

- フィールド選択機能
- カスタムフィールドの包含
- スケジュール実行機能

##### FR-CT-031: エクスポート処理

- 非同期処理（キュージョブ）
- 大量データの処理
- CSV生成
- ファイルの一時保存（S3など）

##### FR-CT-032: エクスポート配信

- メール通知
- ダウンロードリンク生成
- リンクの有効期限管理
- セキュアなファイルアクセス

##### FR-CT-033: エクスポート履歴

- エクスポートアクションの記録
- ダウンロード状態の追跡
- ファイルの自動削除（期限後）

### 3.9 一括操作（Bulk Actions）

#### 3.9.1 利用可能なバルクアクション

##### 1. Create Enrollment（コース登録作成）

- 選択したコンタクトを特定のコースに登録
- 即座に実行またはスケジュール実行
- 登録情報の設定

##### 2. Delete Contacts（コンタクト削除）

- 複数のコンタクトを一括削除
- 確認ダイアログで"DELETE"とタイプ
- 削除不可能なコンタクト（アクティブな購読/注文/登録がある）は「Failed Contacts」に表示
- 削除可能なコンタクトのみ削除実行

##### 3. Export（エクスポート）

- 選択したコンタクトをCSV形式でエクスポート
- フィールド選択
- スケジュール実行可能

##### 4. Run Workflow（ワークフロー実行）

- 選択したコンタクトに対してワークフローを実行
- ワークフロー選択
- Force Run オプション（デフォルト設定を上書きして即座に実行）

##### 5. Tags（タグ操作）

- タグの追加または削除
- 複数タグの同時操作
- スケジュール実行可能

##### 6. Unsubscribe Contacts（購読解除）

- コンタクトをマーケティングコミュニケーションから解除
- 完全削除ではなく購読状態の変更
- 確認ダイアログ表示

#### 3.9.2 バルクアクションの実行フロー

1. コンタクトの選択（チェックボックス）
2. 「Bulk Actions」ボタンをクリック
3. アクションタイプを選択
4. アクション固有の設定
5. スケジュール設定（オプション）
6. 実行確認
7. バックグラウンド処理開始
8. 完了通知

#### 3.9.3 アクションステータスの追跡

##### Actions メニュー

- Contacts → Actions → See All X Actions
- アクション一覧の表示
- ステータスラベル:
  - **QUEUED**: 処理待ち
  - **PROCESSING**: 処理中
  - **COMPLETED**: 完了
  - **FAILED**: 失敗

##### 各アクションタイプの履歴

- **Imports**: インポート履歴と進捗
- **Exports**: エクスポート履歴、ダウンロードリンク、削除オプション
- **Enrollments**: 登録アクション、対象コンタクト、コースID、進捗
- **Tagging**: タグ付けアクション、タグ詳細、対象件数
- **Workflows**: ワークフロー実行履歴、対象コンタクト、通知
- **Deletions**: 削除アクション、削除件数

#### 3.9.4 制限事項

- スマートリストには手動追加/削除不可
- バルクアクションでスマートリストは除外される
- 一部のアクションは条件チェックでスキップされる可能性

#### 3.9.5 機能要件

##### FR-CT-034: バルクアクション実行

- 複数コンタクトの同時処理
- アクションタイプ別の処理ロジック
- スケジュール実行機能
- 非同期処理（キュージョブ）

##### FR-CT-035: バリデーションと条件チェック

- アクション実行前の検証
- 条件に合わないコンタクトのスキップ
- エラーハンドリング
- Failed Contacts の記録

##### FR-CT-036: アクション履歴管理

- すべてのアクションの記録
- ステータス追跡
- 統計情報（成功数/失敗数）
- 詳細情報の保存

##### FR-CT-037: 通知機能

- アクション完了通知
- エラー通知
- 進捗通知（大量処理の場合）

### 3.10 コンタクトアクティビティ追跡

#### 3.10.1 追跡するアクティビティタイプ

##### Pageviews（ページ閲覧）

- 閲覧したページのURL
- ページタイトル
- タイムスタンプ
- セッション情報

##### Visits（訪問）

- 訪問日時
- 参照元URL
- デバイス情報
- 地理的情報

##### Workflows（ワークフロー）

- ワークフロー名
- ステップ名
- ステータス（完了/待機/エラー）
- タイムスタンプ

##### Notes（メモ）

- メモ内容
- 作成者
- 作成日時

##### Tags（タグ操作）

- 追加/削除されたタグ
- 操作者
- タイムスタンプ

##### Enrollments（登録）

- コース名
- 登録/解除
- 進捗状況
- タイムスタンプ

##### Community Posts（コミュニティ投稿）

- 投稿内容
- エンゲージメント
- タイムスタンプ

#### 3.10.2 アクティビティの記録方法

##### 自動記録

- ページ閲覧: JavaScriptトラッキングコード
- ワークフロー: ワークフロー実行時に自動記録
- タグ操作: タグ追加/削除時に自動記録
- 登録: コース登録/解除時に自動記録

##### 手動記録

- メモ: ユーザーまたはワークフローから追加
- カスタムアクティビティ: API経由で記録

#### 3.10.3 アクティビティの表示

##### タイムライン形式

- 最新のアクティビティを上に表示
- 日付によるグループ化
- アクティビティタイプ別のアイコン
- 詳細情報の展開/折りたたみ

##### フィルタリング

- アクティビティタイプで絞り込み
- 日付範囲で絞り込み
- キーワード検索

#### 3.10.4 機能要件

##### FR-CT-038: アクティビティ記録

- 各種アクティビティの自動記録
- メタデータの保存
- タイムスタンプの記録
- ユーザー/システムの識別

##### FR-CT-039: アクティビティ表示

- タイムライン形式での表示
- ページネーションまたは無限スクロール
- リアルタイム更新
- レスポンシブデザイン

##### FR-CT-040: アクティビティ検索

- アクティビティタイプでのフィルタリング
- 日付範囲での絞り込み
- キーワード検索
- 検索結果のハイライト

---

## 4. 非機能要件

### 4.1 パフォーマンス

#### NFR-CT-001: ページ読み込み時間

- コンタクト一覧ページ: 2秒以内
- コンタクトプロファイルページ: 1.5秒以内
- 検索結果表示: 1秒以内

#### NFR-CT-002: スケーラビリティ

- 100万件のコンタクトを扱える
- 同時に1000ユーザーがアクセス可能
- インポート/エクスポート処理の並列化

#### NFR-CT-003: データベース最適化

- 適切なインデックス設定
- クエリの最適化
- キャッシング戦略

### 4.2 セキュリティ

#### NFR-CT-004: データ保護

- 個人情報の暗号化（保存時、転送時）
- アクセス制御（ワークスペース単位）
- 監査ログの記録

#### NFR-CT-005: GDPR/プライバシー対応

- 同意管理（18歳以上、マーケティング許可）
- データ削除の権利（Right to be Forgotten）
- データポータビリティ（エクスポート機能）

#### NFR-CT-006: API セキュリティ

- 認証・認可（OAuth, JWT）
- レート制限
- 入力バリデーション

### 4.3 可用性

#### NFR-CT-007: アップタイム

- 99.9% の可用性
- 定期メンテナンス時の通知

#### NFR-CT-008: バックアップ

- 毎日の自動バックアップ
- ポイントインタイム復元

### 4.4 ユーザビリティ

#### NFR-CT-009: レスポンシブデザイン

- デスクトップ、タブレット、モバイル対応
- タッチデバイス最適化

#### NFR-CT-010: アクセシビリティ

- WCAG 2.1 AA準拠
- キーボードナビゲーション
- スクリーンリーダー対応

---

## 5. API要件

### 5.1 コンタクト管理API

#### GET /api/contacts

コンタクト一覧取得

**クエリパラメータ:**
- `page`: ページ番号
- `per_page`: 1ページあたりの件数
- `sort_by`: ソートフィールド
- `sort_order`: ソート順（asc/desc）
- `status`: 購読状態フィルタ
- `search`: 検索キーワード
- `filters`: JSONエンコードされたフィルタ条件

**レスポンス:**
```json
{
  "data": [
    {
      "id": "uuid",
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "phone": "+1234567890",
      "subscription_status": "subscribed",
      "ltv": 1500.00,
      "tags": [
        {"id": "uuid", "name": "VIP", "color": "#FF5733"}
      ],
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-15T12:30:00Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 10,
    "total_count": 250,
    "per_page": 25
  }
}
```

#### GET /api/contacts/:id

コンタクト詳細取得

**レスポンス:**
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "phone": "+1234567890",
  "street_1": "123 Main St",
  "street_2": "Apt 4B",
  "city": "New York",
  "state": "NY",
  "country": "USA",
  "zip_code": "10001",
  "timezone": "America/New_York",
  "source": "Funnel: Product Launch",
  "subscription_status": "subscribed",
  "ltv": 1500.00,
  "tags": [...],
  "custom_attributes": {
    "favorite_snack": "Chips",
    "vip_status": "Gold"
  },
  "created_at": "2025-01-01T00:00:00Z",
  "updated_at": "2025-01-15T12:30:00Z"
}
```

#### POST /api/contacts

コンタクト作成

**リクエストボディ:**
```json
{
  "email": "newuser@example.com",
  "first_name": "Jane",
  "last_name": "Smith",
  "phone": "+9876543210",
  "tags": ["uuid1", "uuid2"],
  "custom_attributes": {
    "attribute_key": "value"
  }
}
```

#### PATCH /api/contacts/:id

コンタクト更新

#### DELETE /api/contacts/:id

コンタクト削除

### 5.2 カスタム属性API

#### GET /api/contact-attributes

属性定義一覧取得

#### POST /api/contact-attributes

属性定義作成

#### PATCH /api/contact-attributes/:id

属性定義更新

#### DELETE /api/contact-attributes/:id

属性定義削除

### 5.3 タグAPI

#### GET /api/tags

タグ一覧取得

#### POST /api/tags

タグ作成

#### PATCH /api/tags/:id

タグ更新

#### DELETE /api/tags/:id

タグ削除

#### POST /api/contacts/:id/tags

コンタクトにタグ追加

#### DELETE /api/contacts/:id/tags/:tag_id

コンタクトからタグ削除

### 5.4 セグメントAPI

#### GET /api/segments

セグメント一覧取得

#### POST /api/segments

セグメント作成

#### PATCH /api/segments/:id

セグメント更新

#### DELETE /api/segments/:id

セグメント削除

#### GET /api/segments/:id/contacts

セグメント内のコンタクト取得

### 5.5 インポート/エクスポートAPI

#### POST /api/contacts/import

CSVインポート（マルチパートフォーム）

#### POST /api/contacts/export

エクスポート作成

#### GET /api/contact-actions

アクション履歴取得

#### GET /api/contact-actions/:id

アクション詳細取得

### 5.6 バルクアクションAPI

#### POST /api/contacts/bulk-actions

バルクアクション実行

**リクエストボディ:**
```json
{
  "action_type": "tag",
  "contact_ids": ["uuid1", "uuid2", "uuid3"],
  "params": {
    "operation": "add",
    "tag_ids": ["tag-uuid1", "tag-uuid2"]
  },
  "scheduled_at": "2025-02-01T10:00:00Z"
}
```

### 5.7 アクティビティAPI

#### GET /api/contacts/:id/activities

コンタクトのアクティビティ取得

#### POST /api/contacts/:id/activities

アクティビティ記録（カスタムアクティビティ）

#### POST /api/contacts/:id/notes

メモ追加

---

## 6. UI/UXガイドライン

### 6.1 デザイン原則

- **明確性**: 情報を明確に整理し、重要な情報を強調
- **一貫性**: 全体で一貫したデザインパターンを使用
- **効率性**: 少ないクリックで目的を達成できるようにする
- **フィードバック**: ユーザーアクションに対する即座のフィードバック

### 6.2 カラーパレット

- **Primary**: ブランドカラー（アクションボタン、重要な要素）
- **Secondary**: セカンダリカラー（サポート要素）
- **Success**: グリーン（成功メッセージ、購読中ステータス）
- **Warning**: イエロー/オレンジ（警告、注意）
- **Danger**: レッド（削除、エラー、購読解除）
- **Neutral**: グレースケール（テキスト、背景、境界線）

### 6.3 タイポグラフィ

- **見出し**: 明確な階層（H1-H6）
- **本文**: 読みやすいフォントサイズ（14-16px）
- **ラベル**: 小さめだが明確（12-14px）

### 6.4 インタラクション

#### ホバー効果

- ボタン: 背景色の変更、影の追加
- テーブル行: 背景色の微妙な変化
- リンク: アンダーライン、色の変化

#### フォーカス状態

- キーボードナビゲーションのための明確なフォーカスインジケーター
- アクセシビリティ対応

#### ローディング状態

- スピナー/スケルトンスクリーン
- プログレスバー（長時間処理）
- ボタンのローディング状態

#### エラー状態

- インラインエラーメッセージ
- フィールドのハイライト
- 明確なエラーメッセージ

### 6.5 レスポンシブブレークポイント

- **Mobile**: 0-767px
- **Tablet**: 768px-1023px
- **Desktop**: 1024px以上

---

## 7. テストシナリオ

### 7.1 コンタクト一覧

#### TC-CT-001: 一覧表示

- すべてのコンタクトが表示されることを確認
- ページネーションが正しく動作することを確認
- ソート機能が各列で動作することを確認

#### TC-CT-002: 検索機能

- 名前で検索できることを確認
- メールアドレスで検索できることを確認
- 部分一致で検索できることを確認

#### TC-CT-003: フィルタリング

- ステータスタブでフィルタリングできることを確認
- 複数条件でフィルタリングできることを確認
- AND/OR条件が正しく動作することを確認

### 7.2 コンタクト管理

#### TC-CT-004: コンタクト追加

- 必須フィールドのバリデーションを確認
- 重複メールアドレスの検出を確認
- 正常に追加できることを確認

#### TC-CT-005: コンタクト編集

- フィールドの編集ができることを確認
- バリデーションが動作することを確認
- 変更が保存されることを確認

#### TC-CT-006: コンタクト削除

- 単一削除が動作することを確認
- 一括削除が動作することを確認
- 削除不可能なコンタクトが適切に処理されることを確認

### 7.3 カスタム属性

#### TC-CT-007: 属性定義作成

- Text Fieldが作成できることを確認
- Select Fieldが作成できることを確認
- 複数選択が動作することを確認

#### TC-CT-008: 属性値設定

- コンタクトに属性値を設定できることを確認
- 属性値が正しく表示されることを確認
- 属性値で検索/フィルタリングできることを確認

### 7.4 タグ

#### TC-CT-009: タグ作成

- タグが作成できることを確認
- タグ名の重複チェックが動作することを確認
- カラーが設定できることを確認

#### TC-CT-010: タグ付け

- コンタクトにタグを追加できることを確認
- タグを削除できることを確認
- 一括タグ付けが動作することを確認

### 7.5 インポート/エクスポート

#### TC-CT-011: インポート

- CSVファイルをアップロードできることを確認
- フィールドマッピングが動作することを確認
- インポート処理が完了することを確認
- エラーが適切に処理されることを確認

#### TC-CT-012: エクスポート

- コンタクトをエクスポートできることを確認
- フィールド選択が動作することを確認
- CSVファイルがダウンロードできることを確認

### 7.6 バルクアクション

#### TC-CT-013: 一括操作

- 各バルクアクションが動作することを確認
- スケジュール実行が動作することを確認
- アクション履歴が記録されることを確認

---

## 8. 実装優先順位

### Phase 1: コア機能（MVP）

1. ✓ データモデルの構築（Contact, Tag, ContactTag）
2. ✓ コンタクト一覧ページ
3. ✓ コンタクトの追加/編集/削除
4. ✓ 基本的な検索機能
5. ✓ タグ管理とタグ付け

### Phase 2: 拡張機能

1. ✓ カスタム属性機能
2. ✓ 高度なフィルタリング
3. ✓ コンタクトプロファイルページ
4. ✓ アクティビティ追跡（基本）
5. ✓ CSVインポート

### Phase 3: 高度な機能

1. ✓ CSVエクスポート
2. ✓ セグメント（スマートリスト）
3. ✓ バルクアクション
4. ✓ アクション履歴管理
5. ✓ スケジュール実行

### Phase 4: 統合と最適化

1. ✓ ワークフローとの統合
2. ✓ ファネルからの自動タグ付け
3. ✓ パフォーマンス最適化
4. ✓ セキュリティ強化
5. ✓ 監査ログ

---

## 9. 参考資料

### 9.1 ClickFunnels公式ドキュメント

- [Overview of the Contacts Page](https://support.myclickfunnels.com/docs/overview-of-the-contacts-page)
- [Contact Profile Overview](https://support.myclickfunnels.com/docs/contact-profile-overview)
- [How to Manage Contacts](https://support.myclickfunnels.com/docs/contacts-how-to-manage-contacts)
- [How to Export Contacts](https://support.myclickfunnels.com/docs/contacts-how-to-export-contacts)
- [How to Import Contacts From a CSV File](https://support.myclickfunnels.com/docs/how-to-import-contacts-from-a-csv-file)
- [How to Use Actions](https://support.myclickfunnels.com/docs/contacts-how-to-use-actions)
- [Contact Tags Section Overview](https://support.myclickfunnels.com/docs/contact-tags-section-overview)
- [How to Add and Manage Contact Attributes](https://support.myclickfunnels.com/docs/how-to-add-and-manage-contact-attributes-1)
- [How to Add and Manage Contact Segments](https://support.myclickfunnels.com/support/solutions/articles/150000156963-contact-tags-section-overview)
- [How to Tag Contacts from Funnels](https://support.myclickfunnels.com/docs/how-to-tag-contacts-from-funnels)

### 9.2 関連機能

- ワークフロー（Automations）
- メール送信（Broadcasts）
- ファネル（Funnels）
- コース（Courses）

---

## 10. 用語集

- **Contact**: ファネルを通じて獲得したリードまたは顧客
- **Tag**: コンタクトを分類するためのラベル
- **Segment**: 特定の条件でグループ化されたコンタクトの集合
- **Smart List**: ルールに基づいて自動的に更新される動的なセグメント
- **Static List**: 手動で管理される静的なセグメント
- **Custom Attribute**: ユーザー定義のコンタクトフィールド
- **LTV (Lifetime Value)**: 生涯顧客価値、顧客が生涯にわたって生み出す収益
- **Bulk Action**: 複数のコンタクトに対して一括で実行する操作
- **Activity**: コンタクトの行動履歴（ページ閲覧、ワークフロー実行など）
- **Subscription Status**: 購読状態（subscribed/unsubscribed）
- **Field Mapping**: CSVインポート時の列とフィールドの対応付け

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|----------|---------|--------|
| 2025-12-09 | 1.0 | 初版作成 | Claude |

---

**注意**: この要件定義書は、ClickFunnelsのコンタクト管理機能を参考にしたものですが、実装においては独自の判断と改善を加えることが推奨されます。特に、パフォーマンス、セキュリティ、ユーザビリティの観点から最適化を行ってください。
